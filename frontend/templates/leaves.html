{% extends "base.html" %}

{% block title %}Gestion des Congés{% endblock %}

{% block head %}
<!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
<!-- Bootstrap Icons -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
<!-- FullCalendar CSS -->
<link href='https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/6.1.10/main.min.css' rel='stylesheet' />
<link href='https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/6.1.10/daygrid/main.min.css' rel='stylesheet' />
<link href='https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/6.1.10/timegrid/main.min.css' rel='stylesheet' />
<link href='https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/6.1.10/list/main.min.css' rel='stylesheet' />
<!-- Tippy.js CSS -->
<link rel="stylesheet" href="https://unpkg.com/tippy.js@6/dist/tippy.css" />
<!-- Google Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Logo et titre du système -->
    <div class="logo-container">
        <i class="bi bi-building logo-icon"></i>
        <span class="brand-name">Hanna<span>Work</span> System</span>
    </div>
    
    <!-- Panel d'information -->
    <div class="alert alert-info mb-4">
        <h5><i class="bi bi-info-circle me-2"></i>Panneau d'administration des congés</h5>
        <p>Ce tableau de bord vous permet de gérer les demandes de congés de tous les employés.</p>
    </div>

    <!-- Contenu des onglets -->
    <div class="tab-content" id="leavesTabsContent">
        <!-- Toutes les demandes -->
        <div class="tab-pane fade show active" id="all-leaves" role="tabpanel" aria-labelledby="all-leaves-tab">
            <!-- Tableau des congés -->
            <div class="card shadow-md mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-clipboard-data me-2"></i>Liste des demandes de congés</span>
                    <div>
                        <button class="btn btn-sm btn-light" id="refresh-button" onclick="fetchLeaves()">
                            <i class="bi bi-arrow-clockwise"></i> Rafraîchir
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover" id="leave-requests-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Employé</th>
                                    <th>Type</th>
                                    <th>Période</th>
                                    <th>Statut</th>
                                    <th>Commentaire</th>
                                    <th>Actions</th>
                                    <th>Solde</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="8" class="text-center">Chargement des données...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Demandes en attente -->
        <div class="tab-pane fade" id="pending-leaves" role="tabpanel" aria-labelledby="pending-leaves-tab">
            <div class="card shadow-md mb-4">
                <div class="card-header">
                    <span><i class="bi bi-hourglass-split me-2"></i>Demandes en attente</span>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover" id="pending-leaves-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Employé</th>
                                    <th>Type</th>
                                    <th>Période</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="5" class="text-center">Chargement des données...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Demandes approuvées -->
        <div class="tab-pane fade" id="approved-leaves" role="tabpanel" aria-labelledby="approved-leaves-tab">
            <div class="card shadow-md mb-4">
                <div class="card-header">
                    <span><i class="bi bi-check-circle me-2"></i>Demandes approuvées</span>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover" id="approved-leaves-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Employé</th>
                                    <th>Type</th>
                                    <th>Période</th>
                                    <th>Date d'approbation</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="5" class="text-center">Chargement des données...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Calendrier des absences -->
    <div class="card shadow-md mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <span><i class="bi bi-calendar-week me-2"></i>Calendrier des absences de l'équipe</span>
            <div>
                <select id="department-filter" class="form-select form-select-sm">
                    <option value="">Tous les départements</option>
                    <option value="1">Ressources Humaines</option>
                    <option value="2">Informatique</option>
                    <option value="3">Finance</option>
                    <option value="4">Marketing</option>
                </select>
            </div>
        </div>
        <div class="card-body">
            <div id="leave-calendar" class="mt-3"></div>
        </div>
    </div>

    <!-- Section des employés en congé -->
    <div class="card shadow-md mb-4" id="debug-info">
        <div class="card-header">
            <strong><i class="bi bi-people me-2"></i>Liste des employés en congé</strong>
        </div>
        <div class="card-body">
            <div id="employees-on-leave">
                <div class="d-flex justify-content-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Chargement...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de réponse -->
    <div class="modal fade" id="responseModal" tabindex="-1" aria-labelledby="responseModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="responseModalLabel"><i class="bi bi-reply me-2"></i>Répondre à la demande</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
                </div>
                <form onsubmit="submitResponse(event)">
                    <div class="modal-body">
                        <input type="hidden" id="leaveIdInput" name="leaveId">
                        <div class="mb-3">
                            <label class="form-label">Actions disponibles</label>
                            <div class="d-grid gap-2">
                                <button type="button" class="btn btn-success" onclick="approveLeave(document.getElementById('leaveIdInput').value)">
                                    <i class="bi bi-check-circle"></i> Approuver
                                </button>
                                <button type="button" class="btn btn-danger" onclick="rejectLeave(document.getElementById('leaveIdInput').value)">
                                    <i class="bi bi-x-circle"></i> Rejeter
                                </button>
                                <button type="button" class="btn btn-primary" onclick="forwardToSupervisor(document.getElementById('leaveIdInput').value)">
                                    <i class="bi bi-forward"></i> Transférer au superviseur
                                </button>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="responseComment" class="form-label">Commentaire</label>
                            <textarea class="form-control" id="responseComment" rows="3" placeholder="Ajouter un commentaire (optionnel)"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-light" onclick="closeResponseForm()">Fermer</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal pour les détails des événements -->
<div class="modal fade" id="eventModal" tabindex="-1" aria-labelledby="eventModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="eventModalLabel"><i class="bi bi-info-circle me-2"></i>Détails du congé</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="eventModalBody">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-light" data-bs-dismiss="modal">Fermer</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Bootstrap Bundle avec Popper -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<!-- FullCalendar JS -->
<script src='https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/6.1.10/index.global.min.js'></script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/6.1.10/locales/fr.global.min.js'></script>
<!-- Tippy.js -->
<script src="https://unpkg.com/@popperjs/core@2"></script>
<script src="https://unpkg.com/tippy.js@6"></script>

<!-- Custom JS -->
<script src="/static/js/leaves.js"></script>

<!-- Script d'initialisation -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Vérifier que FullCalendar est chargé
    if (typeof FullCalendar === 'undefined') {
        console.error("FullCalendar n'est pas disponible");
        const calendarEl = document.getElementById('leave-calendar');
        if (calendarEl) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'alert alert-danger';
            errorDiv.innerHTML = "Erreur: FullCalendar n'est pas disponible";
            calendarEl.parentNode.insertBefore(errorDiv, calendarEl);
        }
        return;
    }
    
    // Initialiser le calendrier
    console.log('FullCalendar est disponible, initialisation...');
    if (typeof initCalendar === 'function') {
        initCalendar();
    } else {
        console.error("La fonction d'initialisation du calendrier n'est pas disponible");
    }
});
</script>
{% endblock %}